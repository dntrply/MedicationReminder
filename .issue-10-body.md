Summary
On app restart, cleanup marks a same-day pending dose as MISSED, even though 24 hours have not passed and the dose is still pending. Restarting the app again adds another identical MISSED entry, leading to duplicates for the same medication and scheduled time.

Steps To Reproduce
- Create a medication with a reminder today at 09:42.
- Let 09:42 pass without taking/snoozing/skipping. Confirm a pending entry exists (notification was shown).
- Restart the app.
- Observe: a MISSED history entry is inserted for 09:42 even though <24h have elapsed and the item remains pending.
- Restart the app again.
- Observe: another MISSED for the same med/time appears (duplicate).

Expected Behavior
- No MISSED is created while the dose is still same-day pending (<24 hours since scheduled time).
- No duplicates for the same (medicationId, scheduledTime) across restarts.

Actual Behavior
- A MISSED entry is created immediately on restart for a same-day pending dose.
- Repeated restarts can create additional MISSED entries for the same (medicationId, scheduledTime).

Impact
- Incorrect history (false MISSED).
- Duplicate entries clutter History and analytics.
- Confusing user experience: item appears both “overdue/pending” and “missed”.

Root Cause Analysis
- The “gap” backfill logic in cleanup marks any past scheduled time as MISSED if not in history, without bounding to the actual gap window or checking pending state:
  - History fetched only for [gapStart, gapEnd]: app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:323
  - Backfill considers any scheduledTimestamp ≤ gapEnd (no lower bound ≥ gapStart): app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:487
  - Inserts MISSED without dedupe: app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:376
- The 24h “stale pending” path is correct and separate (only removes/marks >24h past): app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:271, app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:291
- No uniqueness constraint in DB: @Insert(onConflict = REPLACE) operates on auto-generated id, so identical (medicationId, scheduledTime) rows do not conflict: app/src/main/java/com/medreminder/app/data/MedicationHistoryDao.kt:12, app/src/main/java/com/medreminder/app/data/MedicationHistory.kt:14

Proposed Resolution
- Constrain the backfill window:
  - In findMissedDosesInGap, only consider scheduledTimestamp within the actual gap window: require scheduledTimestamp ≥ gapStart AND ≤ gapEnd (currently only checks ≤ gapEnd). File: app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:487
- Align backfill with 24h rule for MISSED:
  - Option A (strict): Only treat as MISSED when scheduledTimestamp < now − 24h in both stale-pending and gap paths.
  - Option B (minimal): At least skip same-day occurrences (e.g., require scheduledTimestamp < start of today).
- Skip pending items:
  - Before marking MISSED, check the pending tracker for a matching (medId, hour, minute) occurrence on that day; if pending, do not mark missed.
- Prevent duplicates:
  - Deduplicate missedMedications in memory by key (medicationId, scheduledTimestamp) before inserts.
  - Add a DAO/DB uniqueness guard, e.g., a unique index on (medicationId, scheduledTime[, action]) with @Insert(onConflict = IGNORE) to ensure idempotency. (Note: schema change requires a migration.)
- Idempotent cleanup:
  - If needed, guard cleanup with a single-run mechanism (e.g., unique WorkManager or a mutex) to prevent overlapping runs on rapid restarts.
  - With the gap window fix, repeat runs should be naturally idempotent.

Acceptance Criteria
- Restarting the app on the same day does not create MISSED for pending doses.
- No duplicate MISSED entries per (medicationId, scheduledTime) across restarts.
- Past-day backfill still identifies truly missed doses in the gap window without false positives.
- Unit tests cover:
  - Same-day pending + restart → no MISSED.
  - Gap window backfill respects [gapStart, gapEnd].
  - Idempotent behavior across multiple cleanup runs.
  - Optional: DB-level uniqueness prevents duplicates.

References
- Trigger: MainActivity calls cleanup on start: app/src/main/java/com/medreminder/app/MainActivity.kt:97
- Stale pending (>24h) logic: app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:271 and app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:291
- Gap scan history fetch window: app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:323
- Gap scan time check missing lower bound (only ≤ gapEnd): app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:487
- MISSED insert path: app/src/main/java/com/medreminder/app/notifications/PendingMedicationTracker.kt:376
- Entity/DAO (no uniqueness on scheduled time): app/src/main/java/com/medreminder/app/data/MedicationHistory.kt:14, app/src/main/java/com/medreminder/app/data/MedicationHistoryDao.kt:12
